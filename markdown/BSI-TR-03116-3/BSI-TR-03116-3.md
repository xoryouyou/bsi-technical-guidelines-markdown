![](_page_0_Picture_0.jpeg)

# Technische Richtlinie BSI TR-03116 Kryptographische Vorgaben für Projekte der Bundesregierung

Teil 3: Intelligente Messsysteme

Stand 2025 Datum: 13. Dezember 2024

Bundesamt für Sicherheit in der Informationstechnik Postfach 20 03 63 53133 Bonn Tel.: +49 22899 9582-0 E-Mail: smartmeter@bsi.bund.de Internet: https://www.bsi.bund.de © Bundesamt für Sicherheit in der Informationstechnik 2024

| 1              | Einleitung 5                                                                           |  |
|----------------|----------------------------------------------------------------------------------------|--|
| 1.1            | Geltungsbereich 5                                                                      |  |
| 1.2            | Begrifflichkeiten 6                                                                    |  |
| 1.2.1          | Verwendungszeiträume 6                                                                 |  |
| 1.2.2          | Schlüsselworte 7                                                                       |  |
| 2              | Kryptographische Algorithmen 8                                                         |  |
| 2.1            | Kryptographische Basisverfahren 8                                                      |  |
| 2.2            | Domainparameter für elliptische Kurven 8                                               |  |
| 2.3            | Zufallszahlen 9                                                                        |  |
| 2.4            | Umgang mit Ephemerschlüsseln9                                                          |  |
| 3              | Public Key Infrastruktur 10                                                            |  |
| 4              | TLS-Kommunikation im WAN und in der Marktkommunikation11                               |  |
| 4.1            | Allgemeine Vorgaben 11                                                                 |  |
| 4.1.1          | Authentifizierung und TLS-Zertifikate 11                                               |  |
| 4.1.2          | TLS-Version und Sessions11                                                             |  |
| 4.2            | Vorgaben für TLS 1.2 12                                                                |  |
| 4.2.1<br>4.2.2 | Cipher Suites und Kurvenparameter 12<br>Weitere Vorgaben und Empfehlungen13            |  |
| 4.3            | Vorgaben für TLS 1.3 14                                                                |  |
| 4.3.1          | Cipher Suites und Kurvenparameter 14                                                   |  |
| 4.3.2          | Weitere Vorgaben und Empfehlungen16                                                    |  |
| 5              | TLS-Kommunikation im HAN17                                                             |  |
| 5.1            | Allgemeine Vorgaben 17                                                                 |  |
| 5.1.1          | Authentisierung und TLS-Zertifikate 17                                                 |  |
| 5.1.2          | TLS-Version und Sessions17                                                             |  |
| 5.2            | Cipher Suites und Kurvenparameter17                                                    |  |
| 5.3            | Weitere Vorgaben und Empfehlungen 18                                                   |  |
| 5.3.1<br>5.3.2 | Signaturalgorithmen 18<br>Extensions 18                                                |  |
| 5.3.3          | Migration kryptographischer Verfahren und Schlüssel18                                  |  |
| 6              | TLS-Kommunikation im LMN19                                                             |  |
| 6.1            | Allgemeine Vorgaben 19                                                                 |  |
| 6.2            | Cipher Suites und Kurvenparameter19                                                    |  |
| 6.3            | Authentisierung und TLS-Zertifikate19                                                  |  |
| 6.3.1          | Initialer Austausch und Update der LMN-Zertifikate 20                                  |  |
| 6.4            | Weitere Vorgaben und Empfehlungen 20                                                   |  |
| 6.4.1          | Signaturalgorithmen 20                                                                 |  |
| 6.4.2          | Extensions 21                                                                          |  |
| 6.4.3          | Migration kryptographischer Verfahren und Schlüssel21                                  |  |
| 7              | Kommunikation im LMN auf Basis symmetrischer Kryptographie22                           |  |
| 7.1            | Voraussetzungen22                                                                      |  |
| 7.1.1          | Wechsel des gemeinsamen, zählerindividuellen Schlüssels MK für bidirektionale Zähler23 |  |
| 7.2            | Schlüsselableitung 23                                                                  |  |

#### Inhaltsverzeichnis

| 7.3                   | Übertragung von Zählerdaten 24                                                                                                |  |
|-----------------------|-------------------------------------------------------------------------------------------------------------------------------|--|
| 8                     | Inhaltsdatensicherung im WAN 25                                                                                               |  |
| 8.1<br>8.1.1<br>8.1.2 | Authenticated-Enveloped-data Content Type25<br>Content-Authenticated-Encryption 25<br>Schlüsselableitung und Key Encryption26 |  |
| 8.2                   | Signed-Data Content Type 26                                                                                                   |  |
| 9                     | Inhaltsdatensicherung in der Marktkommunikation27                                                                             |  |
| 9.1                   | Inhaltsdatensignatur 27                                                                                                       |  |
| 9.2<br>9.2.1<br>9.2.2 | Inhaltsdatenverschlüsselung 27<br>Content Encryption 27<br>Key Agreement und Key Encryption28                                 |  |
| 10                    | PACE und Secure Messaging 29                                                                                                  |  |
| 11                    | Zertifizierung 30                                                                                                             |  |
| 11.1                  | Smart-Meter-Gateway 30                                                                                                        |  |
| 11.2                  | Sicherheitsmodul30                                                                                                            |  |
|                       | Literaturverzeichnis 31                                                                                                       |  |

# Tabellenverzeichnis

| Tabelle 1: Verfahren zur Absicherung der Infrastruktur von Messsystemen6                                  |  |
|-----------------------------------------------------------------------------------------------------------|--|
| Tabelle 2: Schlüsselworte 7                                                                               |  |
| Tabelle 3: Kryptographische Primitive8                                                                    |  |
| Tabelle 4: Vom Sicherheitsmodul zu unterstützende Kurvenparameter8                                        |  |
| Tabelle 5: Verfahren und Parameter für die Signatur von Zertifikaten10                                    |  |
| Tabelle 6: Kurvenparameter in TLS-Zertifikaten 11                                                         |  |
| Tabelle 7: Mindestens zu unterstützende Verfahren und Parameter für TLS 1.212                             |  |
| Tabelle 8: Zusätzlich Verfahren und Kurvenparameter für TLS 1.2, deren Unterstützung empfohlen wird13     |  |
| Tabelle 9: Verpflichtend zu unterstützende Hashfunktionen für Signaturen während des TLS-Handshakes 13    |  |
| Tabelle 10: Optional zu unterstützende Hashfunktionen für Signaturen während des TLS-Handshakes13         |  |
| Tabelle 11: Mindestens zu unterstützende Cipher Suites für TLS 1.315                                      |  |
| Tabelle 12: Zusätzliche Cipher Suites für TLS 1.3, deren Unterstützung empfohlen wird15                   |  |
| Tabelle 13: Mindestens zu unterstützende Kurvenparameter für TLS 1.315                                    |  |
| Tabelle 14: Zusätzliche Kurvenparameter, deren Unterstützung für TLS 1.3 empfohlen wird15                 |  |
| Tabelle 15: Zu unterstützende Signaturalgorithmen für die Verifikation von Serversignaturen bei TLS 1.316 |  |
| Tabelle 16: Zu unterstützende Signaturalgorithmen für die Zertifikatsverifikation bei TLS 1.316           |  |
| Tabelle 17: Laufzeiten der LMN-Zertifikate20                                                              |  |
| Tabelle 18: Berechnung der abgeleiteten Schlüssel 23                                                      |  |
| Tabelle 19: Symmetrische Absicherung der Datenübertragung24                                               |  |
| Tabelle 20: Inhaltsdatenverschlüsselung 25                                                                |  |
| Tabelle 21: Schlüsseltransport für die Inhaltsdatenverschlüsselung26                                      |  |
| Tabelle 22: Algorithmen für die CMS Key Encryption 26                                                     |  |
| Tabelle 23: Signatur der verschlüsselten Inhaltsdaten 26                                                  |  |
| Tabelle 24: Signatur der verschlüsselten Inhaltsdaten 27                                                  |  |
| Tabelle 25: Inhaltsdatenverschlüsselung 27                                                                |  |
| Tabelle 26: Schlüsseltransport für die Inhaltsdatenverschlüsselung28                                      |  |
| Tabelle 27: Algorithmen für die XML Key Encryption 28                                                     |  |
| Tabelle 28: PACE und Secure Messaging29                                                                   |  |

# <span id="page-4-0"></span>1 Einleitung

Die Technische Richtlinie BSI TR-03116 stellt eine Vorgabe für Projekte des Bundes dar. Die Technische Richtlinie ist in sechs Teile gegliedert:

- Teil 1 der Technischen Richtlinie beschreibt die Sicherheitsanforderungen für den Einsatz kryptographischer Verfahren im Gesundheitswesen für die elektronische Gesundheitskarte (eGK), den Heilberufeausweis (HBA) und der technischen Komponenten der Telematikinfrastruktur.
- Teil 2 beschreibt die Sicherheitsanforderungen für den Einsatz kryptographischer Verfahren in hoheitlichen Dokumenten und eID-Dokumenten basierend auf Extended Access Control, zurzeit für den elektronischen Reisepass, den elektronischen Personalausweis, den elektronischen Aufenthaltstitel, die eID-Karte für Unionsbürger, die Smart-eID, Änderungsaufkleber hoheitlicher Dokumente, VISA-Aufkleber und den Ankunftsnachweis.
- Im vorliegenden Teil 3 werden die Sicherheitsanforderungen für den Einsatz kryptographischer Verfahren in der Infrastruktur intelligenter Messsysteme im Energiesektor beschrieben.
- Teil 4 der Technischen Richtlinie beschreibt die Sicherheitsanforderungen für den Einsatz der Kommunikationsverfahren SSL/TLS, S/MIME, SAML/XML Security und OpenPGP in Anwendungen des Bundes.
- Teil 5 der Technischen Richtlinie beschreibt die Sicherheitsanforderungen für den Einsatz kryptographischer Verfahren in Anwendungen der Secure Element API (wie Technischen Sicherheitseinrichtungen elektronischer Aufzeichnungssysteme).
- Teil 6 der Technischen Richtlinie beschreibt die Sicherheitsanforderungen für den Einsatz kryptographischer Verfahren in der Infrastruktur kooperativer intelligenter Verkehrssysteme (Cooperative Intelligent Transport Systems / C-ITS).

### 1.1 Geltungsbereich

Die Anforderungen an die Funktionalität, Interoperabilität und Sicherheit der Komponenten von Smart-Metering-Systemen werden in der Technischen Richtlinie TR-03109 [1] spezifiziert.

Basierend auf den Technischen Richtlinien TR-02102 [2] und TR-03111 [3] werden in diesem Dokument verbindlich die einzusetzenden kryptographischen Verfahren und Primitive sowie zu verwendenden Schlüssellängen für die Absicherung der Infrastruktur von intelligenten Messsystemen und der Marktkommunikation vorgegeben.

[Tabelle 1](#page-5-0) gibt einen Überblick über die verwendeten Verfahren und ihren Einsatzzweck.

<span id="page-5-2"></span>

| Einsatzzweck                                                                                                                                                                                      | Verfahren                                       |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
| Sicherstellung der Authentizität von öffentlichen Schlüsseln (vgl. TR                                                                                                                             | Public Key Infrastruktur                        |
| 03109-4 [4])                                                                                                                                                                                      | (vgl. Abschnitt 3)                              |
| Absicherung der Kommunikation zwischen Kommunikationspartnern<br>der Smart-Meter-PKI auf Transportebene im WAN (vgl. TR-03109 [1]) und<br>in der MarktkommunikationFehler: Verweis nicht gefunden | TLS<br>(vgl. Abschnitt 4)                       |
| Absicherung der Kommunikation zwischen Smart-Meter-Gateway und                                                                                                                                    | TLS                                             |
| Teilnehmern im HAN (vgl. TR-03109 [1])                                                                                                                                                            | (vgl. Abschnitt 5)                              |
| Absicherung der Kommunikation von Zählern mit dem Smart-Meter                                                                                                                                     | TLS                                             |
| Gateway im LMN (vgl. TR-03109 [1])                                                                                                                                                                | (vgl. Abschnitt 6)                              |
| Absicherung der Kommunikation von Zählern mit dem Smart-Meter<br>Gateway im LMN für Daten mit niedrigem Schutzbedarf (vgl. TR-03109<br>[1])                                                       | Symmetrische Kryptographie<br>(vgl Abschnitt 7) |
| Vertrauliche, authentische Ende-zu-Ende-Übertragung von Daten über                                                                                                                                | CMS                                             |
| das WAN an den Endempfänger auf Inhaltsebene (vgl. TR-03109 [1])                                                                                                                                  | (vgl. Abschnitt 8)                              |
| Vertrauliche, authentische Ende-zu-Ende-Übertragung von Daten in der                                                                                                                              | XML-Security                                    |
| Marktkommunikation auf InhaltsebeneFehler: Verweis nicht gefunden                                                                                                                                 | (vgl. Abschnitt 9)                              |
| Gegenseitige<br>Authentisierung<br>zwischen<br>Smart-Meter-Gateway<br>und<br>Sicherheitsmodul sowie Aufbau eines sicheren Kanals                                                                  | PACE<br>(vgl. Abschnitt 10)                     |
| Vertrauliche, authentische Kommunikation zwischen<br>Smart-Meter<br>Gateway und Sicherheitsmodul                                                                                                  | Secure Messaging<br>(vgl. Abschnitt 10)         |

<span id="page-5-1"></span><span id="page-5-0"></span>*Tabelle 1: Verfahren zur Absicherung der Infrastruktur von Messsystemen*

# 1.2 Begrifflichkeiten

#### 1.2.1 Verwendungszeiträume

Die Vorgaben des vorliegenden Teils 3 der Technischen Richtlinie basieren auf Prognosen über die Sicherheit der verwendeten kryptographischen Verfahren und Schlüssellängen über einen Zeitraum von 6 Jahren, zur Zeit bis einschließlich 2030 Ist eine weitere Verwendung über diesen Zeitraum hinweg nicht ausgeschlossen, so wird dies mit 2030+ gekennzeichnet.

Diese Technische Richtlinie führt auch Vorgaben mit abgelaufenem Verwendungszeitraum auf, sofern entsprechende Anwendungen möglicherweise weiterhin im Feld bzw. in Nutzung sind.

Wird ein Verwendungsende ohne "+" angegeben, so sollte ein Migrationsplan für die Ausphasung der entsprechenden Anwendung erstellt werden.

Liegt ein Verwendungsanfang in der Zukunft, so sollten rechtzeitig angemessene Tests konzipiert und durchgeführt werden, durch die überprüft werden kann, ob alle notwendigen Voraussetzungen für die Einführung erfüllt sind. Der Testzeitpunkt sollte so gewählt sein, dass mögliche aufgedeckte Mängel noch vor dem Verwendungsanfang behoben werden können.

#### 1.2.2 Schlüsselworte

Anforderungen als Ausdruck normativer Festlegungen werden durch die in Großbuchstaben geschriebenen deutschen Schlüsselworte MUSS/MÜSSEN, DARF NICHT/DÜRFEN NICHT, SOLLTE/SOLLTEN, SOLLTE NICHT/SOLLTEN NICHT, EMPFOHLEN, KANN/KÖNNEN, und OPTIONAL gekennzeichnet. Die verwendeten Schlüsselworte sind auf Basis der Übersetzungen in [Tabelle 2](#page-6-0) gemäß RFC 2119 [5] zu interpretieren.

| Deutsch                       | Englisch    |
|-------------------------------|-------------|
| MUSS / MÜSSEN                 | MUST        |
| DARF NICHT / DÜRFEN NICHT     | MUST NOT    |
| VERPFLICHTEND                 | REQUIRED    |
| SOLLTE / SOLLTEN              | SHOULD      |
| SOLLTE NICHT / SOLLTEN NICHT  | SHOULD NOT  |
| EMPFOHLEN                     | RECOMMENDED |
| KANN / KÖNNEN / DARF / DÜRFEN | MAY         |
| OPTIONAL                      | OPTIONAL    |

<span id="page-6-0"></span>*Tabelle 2: Schlüsselworte*

# <span id="page-7-0"></span>2 Kryptographische Algorithmen

# 2.1 Kryptographische Basisverfahren

[Tabelle 3](#page-7-1) gibt eine Übersicht über die kryptographischen Primitive, die in diesem Dokument verwendet werden.

| Anwendungsfall     | Kryptographische Primitive                                             |
|--------------------|------------------------------------------------------------------------|
| Digitale Signatur  | ECDSA [3]                                                              |
| Schlüsseleinigung  | ECKA-DH [3]                                                            |
| Schlüsseltransport | ECKA-EG [3]                                                            |
| Blockchiffre       | AES [6]<br>•<br>CBC-Mode [7]<br>•<br>GCM-Mode [8]<br>•<br>CCM-Mode [9] |
| MAC-Algorithmus    | AES-CMAC [10]                                                          |
| Hashfunktionen     | SHA-2 Familie [11]                                                     |

<span id="page-7-1"></span>*Tabelle 3: Kryptographische Primitive*

# 2.2 Domainparameter für elliptische Kurven

Für kryptographische Algorithmen und Protokolle basierend auf elliptischen Kurven (d.h. TLS, ECDSA und ECKA) werden NIST-Domain-Parameter über Primkörpern nach RFC 5114 [12] bzw. Brainpool-Domain-Parameter nach RFC 5639 [13] in den entsprechenden Bitlängen verwendet.

Um eine einfache Migration auf andere Verfahren zu ermöglichen, MUSS das Sicherheitsmodul eines Smart-Meter-Gateways

- **•** die Schlüsselerzeugung
- **•** PACE, ECKA-DH, ECKA-EG, ECDSA Signaturerzeugung und -verifikation

gemäß den Vorgaben in der TR-03111 [3] für alle Kurvenparameter aus [Tabelle 4](#page-8-0) unterstützen. Die Vorgaben beziehen sich auf den Zeitpunkt der Herstellung des Smart-Meter-Gateways.

| Kurvenparameter             | Verwendung von | Verwendung bis |
|-----------------------------|----------------|----------------|
| brainpoolP256r1 [13]        | 2015           | 2030+          |
| brainpoolP384r1 [13]        | 2015           | 2030+          |
| brainpoolP512r1 [13]        | 2015           | 2030+          |
| NIST P-256 (secp256r1) [12] | 2015           | 2030+          |
| NIST P-384 (secp384r1) [12] | 2015           | 2030+          |

<span id="page-8-0"></span>*Tabelle 4: Vom Sicherheitsmodul zu unterstützende Kurvenparameter*

Als Encoding für die Punkte der elliptischen Kurven MUSS das Uncompressed Encoding gemäß TR-03111 [3] verwendet werden.

# <span id="page-8-1"></span>2.3 Zufallszahlen

Für die Erzeugung von Zufallszahlen und kryptographischen Schlüsseln (inkl. Ephemerschlüsseln) MUSS in jedem der verwendeten kryptographischen Protokolle ein Zufallszahlengenerator aus einer der folgenden Klassen (siehe AIS 20/31 [14]) verwendet werden:

- **•** DRG.4,
- **•** PTG.3,
- **•** NTG.1.

Abweichend von obigen Vorgaben durfte in bis Ende 2022 hergestellten Geräten auch ein Zufallszahlengenerator der Klasse DRG.3 verwendet werden.

Bei der Erzeugung von unvorhersagbaren Initialisierungsvektoren für symmetrische Verschlüsselungsverfahren im CBC-Mode MÜSSEN die Anforderungen aus der TR-02102 [2] beachtet werden, sofern nicht explizit Abweichendes genannt wird.

# 2.4 Umgang mit Ephemerschlüsseln

Ephemerschlüssel und Sitzungsschlüssel MÜSSEN nach ihrer Verwendung unwiderruflich gelöscht werden. Ephemer- bzw. Sitzungsschlüssel DÜRFEN NICHT für mehr als *eine* Sitzung benutzt werden oder persistent abgespeichert werden. Dies gilt insbesondere für Master-Secret und Pre-Master-Secret bei TLS (vgl. Kapitel 4) sowie Content bzw. Key Encryption Keys bei CMS (vgl. Kapitel 8) und XML Security (vgl. Kapitel [9\)](#page-26-0).

# <span id="page-9-0"></span>3 Public Key Infrastruktur

Die Authentizität der öffentlichen Schlüssel von Kommunikationspartnern im WAN und der Marktkommunikation, welche zur gegenseitigen Authentisierung und zum Aufbau eines verschlüsselten, integritätsgesicherten TLS-Kanals bzw. zur Verschlüsselung oder Signatur von Daten auf Inhaltsebene eingesetzt werden, wird durch die Smart Metering Public Key Infrastruktur (SM-PKI) sichergestellt. Die SM-PKI wird in der TR-03109-4 [4] und in der Certificate Policy der SM-PKI [15] spezifiziert.

Die SM-PKI besteht demnach aus einer *Root-CA* als nationale Wurzelinstanz, *Sub-CAs* für die Ausstellung der Endnutzerzertifikate sowie den *Endnutzerzertifikaten*. Zu den Endnutzern gehören insbesondere die Marktteilnehmer, die Gateway-Administratoren und die Smart-Meter-Gateways (vgl. [15]).

Als Signaturverfahren, mit dem die X.509-Zertifikate und -Sperrlisten signiert werden, MUSS das Verfahren ECDSA gemäß TR-03111 [3], Kapitel 5.2.2, verwendet werden.

[Tabelle 5](#page-9-3) enthält die Hashfunktionen und Kurvenparameter, die von CAs für die Ausstellung von Zertifikaten verwendet werden MÜSSEN. Die Verwendungszeiträume beziehen sich auf die Erstellung der Zertifikate und somit auf den Zeitpunkt, an dem eine CA das jeweilige Zertifikat eines Antragstellers innerhalb der SM-PKI signiert. Für die Root-CA betrifft diese Vorgabe also sowohl die Selbstsignatur bei der Ausstellung von Root-Zertifikaten als auch die Signatur bei der Ausstellung von Sub-CA-Zertifikaten.

<span id="page-9-4"></span>

| Verfahren/Parameter | Vorgaben              | Verwendung von | Verwendung bis |
|---------------------|-----------------------|----------------|----------------|
| Root-CA             |                       |                |                |
| Signaturalgorithmus | ecdsa-with-SHA384 [3] | 2015           | 20251          |
|                     | ecdsa-with-SHA512 [3] | 20251          | 2030+          |
| Kurvenparameter     | brainpoolP384r1 [13]  | 2015           | 20251          |
|                     | brainpoolP512r1 [13]  | 20251          | 2030+          |
| Sub-CAs             |                       |                |                |
| Signaturalgorithmus | ecdsa-with-SHA256 [3] | 2015           | 20252          |
|                     | ecdsa-with-SHA384 [3] | 20252          | 2030+          |
| Kurvenparameter     | brainpoolP256r1 [13]  | 2015           | 20252          |
|                     | brainpoolP384r1 [13]  | 20252          | 2030+          |

<span id="page-9-5"></span><span id="page-9-3"></span>*Tabelle 5: Verfahren und Parameter für die Signatur von Zertifikaten*

Die Laufzeiten der Zertifikate werden in der TR-03109-4 [4] verbindlich vorgegeben. Zur Durchführung der Zertifikatsverifikation gemäß Certificate Policy der SM-PKI [15] MÜSSEN sämtliche Teilnehmer der SM-PKI insbesondere alle in der Zertifikatskette eingesetzten Verfahren und Parameter unterstützen.

- <span id="page-9-2"></span>[1](#page-9-4) Die Umstellung erfolgt mit dem planmäßigen Zertifikatswechsel der Root-CA.
- <span id="page-9-1"></span>[2](#page-9-5) Die Umstellung erfolgt mit dem Wechsel der Schlüssellänge im übergeordneten Root-Zertifikat.

# <span id="page-10-0"></span>4 TLS-Kommunikation im WAN und in der Marktkommunikation

Zwischen Kommunikationspartnern der SM-PKI im WAN und in der Marktkommunikation wird zum Aufbau eines verschlüsselten/integritätsgesicherten und gegenseitig authentisierten Transportkanals das TLS-Protokoll verwendet. Dieses Kapitel legt die hierbei einzusetzenden kryptographischen Parameter verbindlich fest. Es ist ratsam, die TLS-Konfiguration durch Tests zu überprüfen. Die Testspezifikation TR-03116-TS [16] beschreibt entsprechende Testfälle.

# 4.1 Allgemeine Vorgaben

# <span id="page-10-2"></span>4.1.1 Authentifizierung und TLS-Zertifikate

Zur gegenseitigen Authentifizierung MUSS jede Partei ein TLS-Zertifikat aus der SM-PKI für ein Schlüsselpaar verwenden, das zur Erzeugung von Signaturen mit ECDSA (gemäß TR-03111 [3]) geeignet ist.

Hierbei MÜSSEN die Kurvenparameter aus [Tabelle 6](#page-10-1) verwendet werden. Der Verwendungszeitraum bezieht sich auf die Erstellung der Zertifikate.

| Kurvenparameter      | Verwendung von | Verwendung bis |
|----------------------|----------------|----------------|
| brainpoolP256r1 [13] | 2015           | 2030+          |

<span id="page-10-1"></span>*Tabelle 6: Kurvenparameter in TLS-Zertifikaten*

Für die Zertifikatsverifikation in der SM-PKI gelten die Anforderungen aus Kapitel [3](#page-9-0).

#### 4.1.2 TLS-Version und Sessions

Das TLS-Protokoll MUSS mindestens nach Version 1.2 nach RFC 5246 [17] implementiert werden. Ein Fallback auf eine ältere TLS-Version als TLS 1.2 DARF NICHT möglich sein. Die Unterstützung der TLS-Version 1.3 nach RFC 8446 [18] wird EMPFOHLEN. Das Smart-Meter-Gateway SOLLTE beim TLS-Handshake, im Client-Hello, anstelle der eigenen Zeit, eine Zufallszahl als gmt\_unix\_time verwenden.

Kommunikationspartner im WAN MÜSSEN eine TLS-Session (inklusive eventueller Session Resumptions) auf einen Wert begrenzen, der 48 Stunden nicht überschreitet. Beim Smart-Meter-Gateway SOLLTE dieser Wert durch den Gateway Administrator konfigurierbar sein. Insbesondere MUSS das Smart-Meter-Gateway bestehende TLS-Verbindungen nach Ablauf dieser Zeit beenden und für eine neue Verbindung einen neuen TLS-Handshake durchführen.

Innerhalb der erlaubten Session-Lebensdauer KANN Session Resumption verwendet werden. Hierbei KANN eine Stateless Resumption nach RFC 5077 [19] unterstützt und genutzt werden. In diesem Falle MÜSSEN die Anforderungen aus RFC 5077 [19], insbesondere Kapitel 4 und 5, beachtet werden. Die Server-Schlüssel für die Verschlüsselung und Sicherung der Authentizität von Tickets für eine Session Resumption MÜSSEN vom Server sicher gespeichert, verarbeitet und regelmäßig gewechselt werden. Nach Ablauf der Nutzungszeit MÜSSEN die Schlüssel unverzüglich vernichtet werden.

Session Renegotiation DARF NICHT möglich sein.

# <span id="page-11-1"></span>4.2 Vorgaben für TLS 1.2

#### 4.2.1 Cipher Suites und Kurvenparameter

Die TLS-Implementierung MUSS gemäß RFC 5289 [20] mit ephemerem ECDH erfolgen. Dabei stehen grundsätzlich folgende Cipher Suites zur Verfügung:

- **•** TLS\_ECDHE\_ECDSA\_WITH\_AES\_128\_CBC\_SHA256
- **•** TLS\_ECDHE\_ECDSA\_WITH\_AES\_256\_CBC\_SHA384
- **•** TLS\_ECDHE\_ECDSA\_WITH\_AES\_128\_GCM\_SHA256
- **•** TLS\_ECDHE\_ECDSA\_WITH\_AES\_256\_GCM\_SHA384

Die Wahl der Cipher Suite legt bei TLS 1.2 folgende Bereiche des TLS-Protokolls fest:

- **•** Schlüsselaustausch
- **•** Authentifizierung
- **•** Hashfunktion
- **•** Verschlüsselung und Message Authentication Code (MAC).

[Tabelle 7](#page-11-0) enthält die Cipher Suites und elliptischen Kurven nach RFC 5114 [12] und RFC 7027 [21], die für die TLS-Kommunikation von Kommunikationspartnern im WAN und in der Marktkommunikation mindestens unterstützt werden MÜSSEN.

| Verfahren/Parameter                       | Verwendung von | Verwendung bis |  |
|-------------------------------------------|----------------|----------------|--|
| Cipher Suites                             |                |                |  |
| TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256   | 2015           | 2030+          |  |
| TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256   | 2024           | 2030+          |  |
| Kurvenparameter                           |                |                |  |
| NIST P-256 (secp256r1) [12] (IANA-Nr. 23) | 2015           | 2030+          |  |
| brainpoolP256r1 [21] (IANA-Nr. 26)        | 2015           | 2030+          |  |
| brainpoolP384r1 [21] (IANA-Nr. 27)        | 2022           | 2030+          |  |

<span id="page-11-0"></span>*Tabelle 7: Mindestens zu unterstützende Verfahren und Parameter für TLS 1.2*

Um eine langfristige Nutzung zu ermöglichen, SOLLTEN für TLS zusätzlich auch die in [Tabelle 8](#page-12-0) genannten Cipher Suites und elliptischen Kurven unterstützt werden.

| Verfahren/Parameter                     | Verwendung von | Verwendung bis |
|-----------------------------------------|----------------|----------------|
| Cipher Suites                           |                |                |
| TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384 | 2015           | 2030+          |

<span id="page-12-3"></span>

| TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256   | 0    | 20243 |  |
|-------------------------------------------|------|-------|--|
| TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384   | 2015 | 2030+ |  |
| Kurvenparameter                           |      |       |  |
| brainpoolP384r1 [21] (IANA-Nr. 27)        | 0    | 20214 |  |
| brainpoolP512r1 [21] (IANA-Nr. 28)        | 2015 | 2030+ |  |
| NIST P-384 (secp384r1) [12] (IANA-Nr. 24) | 2015 | 2030+ |  |

<span id="page-12-7"></span><span id="page-12-5"></span><span id="page-12-0"></span>*Tabelle 8: Zusätzlich Verfahren und Kurvenparameter für TLS 1.2, deren Unterstützung empfohlen wird*

Die unterstützten Verfahren und Kurven MÜSSEN vom Client hierbei in den entsprechenden Datenfeldern[5](#page-12-8) als Named Curves angezeigt werden. Zudem MÜSSEN Clients und Server die ec\_point\_format-Extension gemäß RFC 8422 [22] verwenden.

Andere Cipher Suites oder elliptische Kurven, als die in [Tabelle 7](#page-11-0) oder [Tabelle 8](#page-12-0) genannten, DÜRFEN NICHT für die Kommunikation im WAN oder in der Marktkommunikation unterstützt werden.

#### 4.2.2 Weitere Vorgaben und Empfehlungen

#### <span id="page-12-12"></span>4.2.2.1 Signaturalgorithmen

Digitale Signaturen während des TLS Handshakes MÜSSEN mit ECDSA erstellt werden. Hierbei MÜSSEN die Hashfunktionen aus [Tabelle 9](#page-12-2) unterstützt werden.

| Verfahren/Parameter | Verwendung von | Verwendung bis |
|---------------------|----------------|----------------|
| SHA-256             | 2015           | 2030+          |
| SHA-384             | 2015           | 2030+          |
| SHA-512             | 2022           | 2030+          |

<span id="page-12-2"></span>*Tabelle 9: Verpflichtend zu unterstützende Hashfunktionen für Signaturen während des TLS-Handshakes*

Zusätzlich SOLLTEN die Hashfunktionen aus [Tabelle 10](#page-12-1) unterstützt werden.

| Verfahren/Parameter | Verwendung von | Verwendung bis |
|---------------------|----------------|----------------|
| SHA-512             | 2015           | 20216          |

<span id="page-12-9"></span><span id="page-12-1"></span>*Tabelle 10: Optional zu unterstützende Hashfunktionen für Signaturen während des TLS-Handshakes*

<span id="page-12-11"></span>Die unterstützten Verfahren MÜSSEN dem Kommunikationspartner dabei in den entsprechenden Datenfeldern[7](#page-13-0) angezeigt werden. Andere als die in [Tabelle 9](#page-12-2) und [Tabelle 10](#page-12-1) angegebenen Hashfunktionen DÜRFEN NICHT verwendet werden.

- <span id="page-12-4"></span>[3](#page-12-3) Ab 2024 ist die Unterstützung verpflichtend, vgl. [Tabelle 7.](#page-11-0)
- <span id="page-12-6"></span>[4](#page-12-5) Seit 2022 ist die Unterstützung verpflichtend, vgl. [Tabelle 7.](#page-11-0)
- <span id="page-12-8"></span>[5](#page-12-7) Vgl. RFC 5246 [17], Kapitel 7.4.1.2 (ClientHello Message), und RFC 8422 [22], Kapitel 5.1 (Supported Elliptic Curves Extension elliptic\_curves), vgl. RFC 8446 [18], Kapitel 4.2.7 (supported\_groups Extension).
- <span id="page-12-10"></span>[6](#page-12-9) Seit 2022 ist die Unterstützung verpflichtend, vgl. [Tabelle 9.](#page-12-2)

#### <span id="page-13-4"></span>4.2.2.2 Extensions

Für Extensions gelten ergänzend zu TR-03109-1 [23] folgende Regeln:

- Eine Verkürzung der Ausgabe des HMAC DARF NICHT verwendet bzw. akzeptiert werden[8](#page-13-2) .
- <span id="page-13-1"></span>• Im Allgemeinen werden bei TLS gemäß RFC 5246 [17] Klartextdaten zunächst integritätsgesichert (MAC) und anschließend werden Klartext und MAC verschlüsselt (MAC-then-Encrypt). Grundsätzlich ist aber die Verwendung von Encrypt-then-MAC oder Authenticated Encryption vorzuziehen (vgl. Bellare und Nampempre [25]). Daher wird die Verwendung von Encrypt-then-MAC gemäß RFC 7366 [26] EMPFOHLEN, d.h.
	- TLS-Clients SOLLTEN die Encrypt-then-MAC-Extension im Client-Hello anbieten und
	- TLS-Server SOLLTEN entweder eine GCM Cipher Suite auswählen oder die Encrypt-then-MAC-Extension im Server-Hello verwenden.

Spätestens ab 2025 MUSS die Encrypt-then-MAC-Extension von TLS-Clients unterstützt und im Client-Hello angeboten werden. Spätestens ab 2025 MÜSSEN TLS-Server, wenn die Extension vom TLS-Client angeboten wird, entweder eine GCM Cipher Suite auswählen oder die Encrypt-then-MAC-Extension verwenden.

• Im Allgemeinen erfolgt bei TLS gemäß RFC 5246 [17] die Berechnung des Master Secrets so, dass nicht alle kryptographischen Parameter aus dem TLS-Handshake in die Berechnung einbezogen werden. Je nach verwendeten kryptographischen Parametern kann die fehlende Einbeziehung dieser Daten zu Angriffen auf eine TLS-Session führen (vgl. etwa Triple-Handshake-Angriff nach Bhargavan, Delignat-Lavaud, Fournet, Pironti und Strub [27]). Auch grundsätzlich ist es empfohlen, kontextspezifische Daten in die Berechnung von Session-Schlüsseln einzubeziehen. Daher SOLLTEN Kommunikationspartner im WAN die Extended Master Secret Extension gemäß RFC 7627 [28] verwenden. Hierbei fließen die kryptographischen Parameter in Form eines *Session Hash* (Hashwert über alle Nachrichten des TLS-Handshakes) in die Berechnung des Master Secrets ein.

# <span id="page-13-3"></span>4.3 Vorgaben für TLS 1.3

Bei der Verwendung von TLS 1.3 gemäß RFC 8446 [18] MUSS folgender Handshake-Modus unterstützt werden:

• ECDHE (ephemerer ECDH)

Zur Unterstützung von Session Resumption KANN zudem folgender Handshake-Modus unterstützt werden:

• PSK mit ECDHE

Das Senden oder Annehmen von 0-RTT Daten DARF NICHT erfolgen. Andere Handshake-Modi DÜRFEN NICHT unterstützt werden.

#### 4.3.1 Cipher Suites und Kurvenparameter

Bei TLS 1.3 definiert eine Cipher Suite die zu verwendenden Algorithmen für

- **•** die authentisierte Verschlüsselung der Datenpakete (Blockchiffre inkl. Betriebsmodus) und
- <span id="page-13-0"></span>[7](#page-12-11) Vgl. RFC 5246 [17], Kapitel 7.4 (ServerKeyExchange, CertificateVerify, CertificateRequest Messages und supported\_signature\_Algorithms Extension).
- <span id="page-13-2"></span>[8](#page-13-1) Vgl. RFC 6066 [24], Kapitel 7 (truncated\_hmac-Extension).

**•** die Hashfunktion für die Schlüsselableitung.

[Tabelle 11](#page-14-1) enthält die Cipher Suites, die bei der Verwendung von TLS 1.3 für die Kommunikation zwischen Kommunikationspartnern im WAN und in der Marktkommunikation mindestens unterstützt werden MÜSSEN.

| Cipher Suites          | Verwendung von | Verwendung bis |
|------------------------|----------------|----------------|
| TLS_AES_128_GCM_SHA256 | 2020           | 2030+          |

<span id="page-14-1"></span>*Tabelle 11: Mindestens zu unterstützende Cipher Suites für TLS 1.3*

Um eine langfristige Nutzung zu ermöglichen, SOLLTEN für TLS 1.3 zusätzlich auch die in [Tabelle 12](#page-14-3) genannten Cipher Suites unterstützt werden.

| Cipher Suites          | Verwendung von | Verwendung bis |
|------------------------|----------------|----------------|
| TLS_AES_256_GCM_SHA384 | 2020           | 2030+          |
| TLS_AES_128_CCM_SHA256 | 2020           | 2030+          |

<span id="page-14-3"></span>*Tabelle 12: Zusätzliche Cipher Suites für TLS 1.3, deren Unterstützung empfohlen wird*

[Tabelle 13](#page-14-2) enthält die elliptischen Kurven nach RFC 8446 [18] und RFC 8734 [29], die bei der Verwendung von TLS 1.3 mindestens unterstützt werden MÜSSEN.

| Kurvenparameter                         | Verwendung von | Verwendung bis |
|-----------------------------------------|----------------|----------------|
| brainpoolP256r1tls13 (IANA-Nr. 31) [29] | 2020           | 2030+          |
| brainpoolP384r1tls13 (IANA-Nr. 32) [29] | 2020           | 2030+          |
| secp256r1 (IANA-Nr. 23) [18]            | 2020           | 2030+          |

<span id="page-14-2"></span>*Tabelle 13: Mindestens zu unterstützende Kurvenparameter für TLS 1.3*

Zudem SOLLTEN bei der Verwendung von TLS 1.3 zusätzlich auch die in [Tabelle 14](#page-14-0) genannten elliptischen Kurven unterstützt werden.

| Kurvenparameter                         | Verwendung von | Verwendung bis |
|-----------------------------------------|----------------|----------------|
| brainpoolP512r1tls13 (IANA-Nr. 33) [29] | 2020           | 2030+          |
| secp384r1 (IANA-Nr. 24) [18]            | 2020           | 2030+          |

<span id="page-14-0"></span>*Tabelle 14: Zusätzliche Kurvenparameter, deren Unterstützung für TLS 1.3 empfohlen wird*

Andere Cipher Suites oder elliptische Kurven, als die in den Tabellen [11](#page-14-1)[-14](#page-14-0) genannten, DÜRFEN NICHT für die Kommunikation im WAN oder in der Marktkommunikation unterstützt werden.

### 4.3.2 Weitere Vorgaben und Empfehlungen

#### <span id="page-14-4"></span>4.3.2.1 Signaturalgorithmen

Bei der Verwendung von TLS 1.3 MÜSSEN Kommunikationspartner im WAN die Signature-Algorithm-Extension verwenden, um die unterstützten Signaturalgorithmen für die Verifikation von Serversignaturen im Rahmen des Handshakes anzuzeigen.

[Tabelle 15](#page-15-1) enthält die Signaturverfahren, die für die Verifikation von Serversignaturen bei der Verwendung von TLS 1.3 unterstützt werden MÜSSEN. Andere Signaturalgorithmen für die Verifikation von Serversignaturen, als die in [Tabelle 15](#page-15-1) genannten, DÜRFEN NICHT für TLS 1.3 unterstützt werden.

| Verfahren/Parameter               | Verwendung von | Verwendung bis |
|-----------------------------------|----------------|----------------|
| ecdsa_brainpoolP256r1tls13_sha256 | 2020           | 2030+          |
| ecdsa_brainpoolP384r1tls13_sha384 | 2020           | 2030+          |
| ecdsa_brainpoolP512r1tls13_sha512 | 2020           | 2030+          |
| ecdsa_secp256r1_sha256            | 2020           | 2030+          |
| ecdsa_secp384r1_sha384            | 2020           | 2030+          |

<span id="page-15-1"></span>*Tabelle 15: Zu unterstützende Signaturalgorithmen für die Verifikation von Serversignaturen bei TLS 1.3*

Bei der Verwendung von TLS 1.3 MÜSSEN die Kommunikationspartner im WAN die Signature\_Algorithm\_Cert-Extension verwenden, um die für die Zertifikatsverifikation unterstützten Signaturalgorithmen anzuzeigen.

[Tabelle 16](#page-15-0) enthält die Signaturverfahren, die bei der Verwendung von TLS 1.3 für die Zertifikatsverifikation entsprechend Kapitel [4.1.1](#page-10-2) unterstützt werden MÜSSEN. Andere Signaturalgorithmen für die Zertifikatsverifikation, als die in [Tabelle 16](#page-15-0) genannten, DÜRFEN NICHT für TLS 1.3 unterstützt werden.

| Verfahren/Parameter               | Verwendung von | Verwendung bis |
|-----------------------------------|----------------|----------------|
| ecdsa_brainpoolP256r1tls13_sha256 | 2020           | 2030+          |
| ecdsa_brainpoolP384r1tls13_sha384 | 2020           | 2030+          |
| ecdsa_brainpoolP512r1tls13_sha512 | 2020           | 2030+          |

<span id="page-15-0"></span>*Tabelle 16: Zu unterstützende Signaturalgorithmen für die Zertifikatsverifikation bei TLS 1.3*

# <span id="page-16-0"></span>5 TLS-Kommunikation im HAN

Das TLS-Protokoll dient im HAN zum Aufbau eines authentisierten sicheren Kanals zwischen Smart-Meter-Gateway und Komponenten im HAN (wie etwa die Anzeigeeinheit oder CLS-Systeme) (vgl. TR-03109-1 [23]). Es ist ratsam, die TLS-Konfiguration durch Tests zu überprüfen. Die Testspezifikation TR-03116-TS [16] beschreibt entsprechende Testfälle.

# 5.1 Allgemeine Vorgaben

### 5.1.1 Authentisierung und TLS-Zertifikate

Für die gegenseitige Authentisierung in der TLS-Kommunikation im HAN werden in der TR-03109-1 [23] zwei mögliche Umsetzungsszenarien (PKI-basierte vs. selbstsignierte Zertifikate) beschrieben.

Für Zertifikate im HAN MÜSSEN Kurvenparameter aus [Tabelle 4](#page-8-0) dieser Technischen Richtlinie verwendet werden. Hierbei ist grundsätzlich die Verwendung von Brainpool-Kurven ratsam.

Bei einer Umsetzung mittels TLS-Zertifikaten der SM-PKI gelten darüber hinaus die weiteren Anforderungen und Hinweise aus Kapitel [4.1.1](#page-10-2).

Die maximalen Zertifikatslaufzeiten hängen vom konkreten Umsetzungsszenario (PKI-basierte vs. selbstsignierte Zertifikate) ab und werden von der TR-03109-1 [23] festgelegt.

#### 5.1.2 TLS-Version und Sessions

Das TLS-Protokoll MUSS mindestens nach Version 1.2 nach RFC 5246 [17] implementiert werden. Ein Fallback auf eine ältere TLS-Version DARF NICHT möglich sein. Die Unterstützung der TLS-Version 1.3 nach RFC 8446 [18] wird EMPFOHLEN.

Das Smart-Meter-Gateway MUSS eine TLS-Session (inklusive eventueller Session Resumptions) auf einen Wert begrenzen, der 48 Stunden nicht überschreitet. Dieser Wert SOLLTE durch den Gateway Administrator konfigurierbar sein. Insbesondere MUSS das Smart-Meter-Gateway bestehende TLS-Verbindungen mit Ablauf dieser Zeit beenden und für eine neue Verbindung einen neuen TLS-Handshake durchführen.

Innerhalb der erlaubten Session-Lebensdauer KANN Session Resumption verwendet werden. Im Falle einer Stateless Resumption MÜSSEN die Anforderungen aus RFC 5077 [19], insbesondere Kapitel 5, beachtet werden.

Session Renegotiation DARF NICHT möglich sein.

# 5.2 Cipher Suites und Kurvenparameter

Smart-Meter-Gateway und HAN-Komponenten MÜSSEN die Anforderungen an Cipher Suites und Kurvenparameter aus Kapitel [4.2](#page-11-1) und [4.3](#page-13-3) auch für die TLS-Kommunikation im HAN einhalten.

Zusätzlich MÜSSEN Smart-Meter-Gateway und HAN-Komponenten für die TLS-Kommunikation im HAN die in Kapitel [4.2](#page-11-1) und [4.3](#page-13-3) empfohlenen Cipher Suites und Kurvenparameter unterstützen.

# 5.3 Weitere Vorgaben und Empfehlungen

#### 5.3.1 Signaturalgorithmen

Smart-Meter-Gateways und Komponenten im HAN MÜSSEN für die TLS-Kommunikation im HAN bzgl. Unterstützung und Verwendung von Signaturalgorithmen während des TLS-Handshakes die Anforderungen aus Kapitel [4.2.2.1](#page-12-12) bei der Verwendung von TLS 1.2 und Kapitel [4.3.2.1](#page-14-4) bei der Verwendung von TLS 1.3 einhalten.

#### 5.3.2 Extensions

Smart-Meter-Gateways und HAN Komponenten MÜSSEN bei der Verwendung von TLS 1.2 bzgl. der Unterstützung und Verwendung von Extensions die Anforderungen aus Kapitel [4.2.2.2](#page-13-4) auch für die Kommunikation im HAN einhalten.

Für Extensions gelten ergänzend zu TR-03109-1 [23] folgende Regeln:

- <span id="page-17-0"></span>• Ebenso wie in Kapitel [4.2.2.2](#page-13-4) gilt: Eine Verkürzung der Ausgabe des HMAC DARF NICHT verwendet bzw. akzeptiert werden[9](#page-17-1) .
- Ebenso wie in Kapitel [4.2.2.2](#page-13-4) gilt: Im Allgemeinen werden bei TLS 1.2 gemäß RFC 5246 [17] Klartextdaten zunächst integritätsgesichert (MAC) und anschließend werden Klartext und MAC verschlüsselt (MAC-then-Encrypt). Grundsätzlich ist aber die Verwendung von Encrypt-then-MAC oder Authenticated Encryption vorzuziehen (vgl. Bellare und Nampempre [25]). Daher wird die Verwendung von Encrypt-then-MAC gemäß RFC 7366 [26] EMPFOHLEN, d.h.
	- TLS-Clients SOLLTEN die encrypt\_then\_MAC-Extension im Client-Hello anbieten und
	- TLS-Server SOLLTEN entweder eine GCM Cipher Suite auswählen oder die encrypt\_then\_MAC-Extension im Server-Hello verwenden.

Spätestens ab 2025 MUSS die encrypt\_then\_MAC-Extension von TLS-Clients unterstützt und im Client-Hello angeboten werden. Spätestens ab 2025 MÜSSEN TLS-Server, wenn die Extension vom TLS-Client angeboten wird, entweder eine GCM Cipher Suite auswählen oder die encrypt\_then\_MAC-Extension verwenden.

• Im Allgemeinen erfolgt bei TLS 1.2 gemäß RFC 5246 [17] die Berechnung des Master Secret ohne die direkte Einbeziehung kryptographischer Parameter aus dem TLS-Handshake. Je nach verwendeten kryptographischen Parametern kann dies zu Angriffen auf eine TLS-Session führen. Die extended\_master\_secret-Extension dient der Abwehr solcher Angriffe, indem ein Session-Hash in die Berechnung des Master Secrets einfließt. Daher SOLLTE spätestens ab 2024 die extended\_master\_secret-Extension gemäß RFC 7627 [28] unterstützt und im Client-Hello sowie im Server-Hello angeboten werden.

#### 5.3.3 Migration kryptographischer Verfahren und Schlüssel

Es wird EMPFOHLEN, Komponenten im HAN mit der Möglichkeit auszustatten, in Zukunft neue Schlüssel einzuspielen bzw. zu erzeugen und ggf. per Firmware-Update neue kryptographische Verfahren einzuspielen, um so eine weitere Verwendbarkeit der Komponenten auch nach einer erforderlichen Migration kryptographischer Verfahren zu ermöglichen.

<span id="page-17-1"></span>[9](#page-17-0) Vgl. RFC 6066 [24], Kapitel 7 (truncated\_hmac-Extension).

# <span id="page-18-0"></span>6 TLS-Kommunikation im LMN

Sofern nicht die Voraussetzungen von Kapitel 7 erfüllt sind, MUSS die Kommunikation zwischen Zählern und Smart-Meter-Gateways per TLS erfolgen. Insbesondere MUSS für die bidirektionale Kommunikation zwischen Smart-Meter-Gateway und Zähler mindestens in folgenden Einsatzszenarien TLS unterstützt werden (vgl. TR-03109-1 [23]):

- <span id="page-18-1"></span>**•** Wechsel des gemeinsamen, zählerindividuellen Schlüssels gemäß Kapitel [Fehler: Verweis nicht](#page-18-1) [gefunden](#page-18-1),
- **•** Auslesen von Zählerdaten,
- **•** Auswahl der auszulesenden Daten.

Es ist ratsam, die TLS-Konfiguration durch Tests zu überprüfen. Die Testspezifikation TR-03116-TS [16] beschreibt entsprechende Testfälle.

# 6.1 Allgemeine Vorgaben

Das TLS-Protokoll MUSS mindestens nach Version 1.2 nach RFC 5246 [17] implementiert werden. Ein Fallback auf eine ältere TLS-Version DARF NICHT möglich sein. Die Unterstützung der TLS-Version 1.3 nach RFC 8446 [18] wird EMPFOHLEN.

Das Smart-Meter-Gateway MUSS die Länge einer TLS-Session (inklusive eventueller Session Resumptions) auf einen Wert begrenzen, der 31 Tage nicht überschreitet. Dieser Wert SOLLTE durch den Gateway Administrator konfigurierbar sein. Insbesondere MUSS das Smart-Meter-Gateway bestehende TLS-Verbindungen mit Ablauf dieser Zeit beenden und für eine neue Verbindung einen neuen TLS-Handshake erzwingen.

Innerhalb der erlaubten Session-Lebensdauer KANN Session Resumption verwendet werden. Im Falle einer Stateless Resumption MÜSSEN die Anforderungen aus RFC 5077 [19], insbesondere Kapitel 5, beachtet werden.

Session Renegotiation DARF NICHT möglich sein.

# 6.2 Cipher Suites und Kurvenparameter

Smart-Meter-Gateways und TLS-Zähler MÜSSEN die Anforderungen an Cipher Suites und Kurvenparameter aus Kapitel [4.2](#page-11-1) und [4.3](#page-13-3) auch für die Kommunikation im LMN einhalten. Für Zähler beziehen sich die Vorgaben zeitlich auf den Einbau des jeweiligen Zählers.

# 6.3 Authentisierung und TLS-Zertifikate

Die Zertifikate für die Kommunikation zwischen Smart-Meter-Gateway und TLS-Zähler sind selbstsigniert (vgl. TR-03109-1 [23]). Insbesondere MUSS das Smart-Meter-Gateway also für die TLS-Kommunikation im WAN und im LMN separate Zertifikate verwenden.

Für Zertifikate im LMN MÜSSEN Kurvenparameter aus [Tabelle 4](#page-8-0) dieser Technischen Richtlinie verwendet werden. Hierbei wird die Verwendung von Brainpool-Kurven empfohlen.

Die maximalen Zertifikatslaufzeiten MÜSSEN den Anforderungen aus [Tabelle 17](#page-19-0) entsprechen.

| Zertifikat       | Gültigkeitszeit | Private Key Usage |
|------------------|-----------------|-------------------|
| Zählerzertifikat | Maximal 7 Jahre | Maximal 7 Jahre   |
| SMGW-Zertifikat  | Maximal 7 Jahre | Maximal 7 Jahre   |

<span id="page-19-0"></span>*Tabelle 17: Laufzeiten der LMN-Zertifikate*

### 6.3.1 Initialer Austausch und Update der LMN-Zertifikate

Für Zähler, die TLS unterstützen, MUSS das initiale Schlüsselpaar vom Hersteller oder vom Smart-Meter-Gateway erzeugt und authentisch in den Zähler eingebracht werden.

<span id="page-19-1"></span>1. Wird das initiale Schlüsselpaar vom Hersteller erzeugt und in den Zähler eingebracht, so MUSS bei erstmaligem Anschluss an ein neues Smart-Meter-Gateway ein authentischer Austausch der TLS-Zertifikate mit dem Smart-Meter-Gateway erfolgen Das initiale zählerindividuelle TLS-Zertifikat ist authentisch in das SMGW zu übertragen.[10](#page-19-2) .

2. Wird das initiale Schlüsselpaar vom Smart-Meter-Gateway erzeugt, so MUSS dieses zusammen mit den Zertifikaten des Smart-Meter-Gateways an den Zähler verschlüsselt und authentisch an den Zähler übertragen werden. Die initiale Übertragung der Zertifikate bzw. die Einbringung des initialen Schlüsselmaterials vom Smart-Meter-Gateway auf dem Zähler MUSS mit dem in Kapitel 7 beschriebenen symmetrischen Verfahren erfolgen. Der dafür verwendete zählerindividuelle Schlüssel MK wird ausschließlich für den authentischen Austausch der Zertifikate und die vertrauliche Übermittlung des initialen Schlüsselmaterials verwendet.

Für das Update eines Smart-Meter-Gateway-Zertifikats MUSS ein neues Schlüsselpaar erzeugt werden und anschließend MUSS das neue selbst-signierte Zertifikat über den aufgebauten TLS-Kanal an den Zähler gesendet werden.

Für das Update eines Zähler-Zertifikats MUSS das Smart-Meter-Gateway ein neues Schlüsselpaar erzeugen und anschließend MUSS das neue selbst-signierte Zertifikat mit dem zugehörigen privaten Schlüssel über den aufgebauten TLS-Kanal an den Zähler gesendet werden.

# 6.4 Weitere Vorgaben und Empfehlungen

#### 6.4.1 Signaturalgorithmen

Smart-Meter-Gateways und TLS-Zähler MÜSSEN bzgl. Unterstützung und Verwendung von Signaturalgorithmen während des TLS-Handshakes die Anforderungen aus Kapitel [4.2.2.1](#page-12-12) und [4.3.2.1](#page-14-4) auch für die Kommunikation im LMN einhalten.

#### 6.4.2 Extensions

Für Extensions gelten ergänzend zur TR-03109-1 [23] folgende Regeln:

<span id="page-19-2"></span>[10](#page-19-1) Hierbei eingesetzte kryptographische Verfahren MÜSSEN den allgemeinen Empfehlungen der TR-02102 [2] entsprechen.

- Im Allgemeinen werden bei TLS 1.2 gemäß RFC 5246 [17] Klartextdaten zunächst integritätsgesichert (MAC) und anschließend werden Klartext und MAC verschlüsselt (MAC-then-Encrypt). Grundsätzlich ist aber die Verwendung von Encrypt-then-MAC vorzuziehen (vgl. Bellare und Nampempre [25]). Daher wird die Verwendung von Encrypt-then-MAC gemäß RFC 7366 [26] EMPFOHLEN. Ab 2025 MÜSSEN Smart-Meter-Gateways und neu verbaute Zähler die Encrypt-then-MAC-Extension unterstützen. Wenn das Smart-Meter-Gateway im LMN als TLS-Client agiert, MUSS es spätestens ab 2025 im Client-Hello die Encrypt-then-MAC-Extension anbieten. Wenn das Smart-Meter-Gateway im LMN als TLS-Server mit einem entsprechenden Zähler als TLS-Client kommuniziert, MUSS es spätestens ab 2025 entweder eine GCM Cipher Suite auswählen oder die Encrypt-then-MAC-Extension verwenden, sofern eine CBC Cipher Suite ausgewählt wird.
- Im Allgemeinen erfolgt bei TLS 1.2 gemäß RFC 5246 [17] die Berechnung des Master Secret ohne die direkte Einbeziehung kryptographischer Parameter aus dem TLS-Handshake. Je nach verwendeten kryptographischen Parametern kann dies zu Angriffen auf eine TLS-Session führen. Daher ist es ratsam, die Extended Master Secret Extension gemäß RFC 7627 [28] zu unterstützen und zu verwenden. Hierbei fließen die kryptographischen Parameter in Form eines Session-Hashs in die Berechnung des Master Secrets ein.

#### 6.4.3 Migration kryptographischer Verfahren und Schlüssel

Die gewünschte Verwendungszeit von TLS-Zählern kann deutlich über den Prognose-Zeitraum hinausgehen. Daher wird EMPFOHLEN, Zähler mit der Möglichkeit auszustatten, neue Schlüssel einzuspielen bzw. zu erzeugen und ggf. per Firmware-Update neue kryptographische Verfahren einzuspielen, um so eine weitere Verwendbarkeit des TLS-Zählers auch in Zukunft zu ermöglichen.

# <span id="page-21-1"></span><span id="page-21-0"></span>7 Kommunikation im LMN auf Basis symmetrischer Kryptographie

Für Zähler, die nur unidirektional kommunizieren können, ist die Möglichkeit von TLS nicht gegeben. Da außerdem Bandbreite und Verfügbarkeit des Kommunikationskanals im LMN auch für bidirektional kommunizierende Zähler unter Umständen starken Einschränkungen unterliegt, sind Zähler nicht immer imstande gemäß den zeitlichen Anforderungen einen TLS-Kanal mit einem Smart-Meter-Gateway aufzubauen.

Daher MUSS das Smart-Meter-Gateway diesen Zählern eine alternative Möglichkeit zum Senden von Messund Zähldaten bereitstellen. Diese Möglichkeit wird im Folgenden beschrieben. Diese Art der Kommunikation KANN für die Auswahl, den Abruf oder die Übertragung von Daten verwendet werden, falls eine Verbindung per TLS nicht möglich ist. Ansonsten DARF diese Art der Kommunikation NICHT verwendet werden.

### 7.1 Voraussetzungen

Zähler und Smart-Meter-Gateway verfügen über einen gemeinsamen geeigneten, symmetrischen Schlüssel *MK*. Dieser Schlüssel *MK* MUSS eine Länge von 128 Bit besitzen und für jeden Zähler individuell zufällig (gemäß den generellen Vorgaben von Kapitel [2.3](#page-8-1) an Zufallszahlen) erzeugt werden. Dieser Schlüssel wird im Folgenden meist kurz zählerindividueller Schlüssel *MK* genannt. Die Erzeugung des zählerindividuellen Schlüssels *MK* MUSS gemäß den Anforderungen aus Kapitel [2.3](#page-8-1)

- durch den Hersteller vorgenommen werden, der den zählerindividuellen Schlüssel *MK* in den Zähler einbringt, oder
- <span id="page-21-2"></span>• durch den Zähler erfolgen, der den zählerindividuellen Schlüssel *MK* an den Hersteller ausgibt.

Vor dem Anschluss des Zählers an ein Smart-Meter-Gateway MUSS der Hersteller des Zählers den initialen zählerindividuellen Schlüssel *MK* vertraulich und authentisch an den Administrator des Gateways übertragen. Der Gateway-Administrator MUSS den initialen zählerindividuellen Schlüssel dann wie in der TR-03109-1 [23] beschrieben gesichert in das Gateway einbringen[11](#page-21-3) .

Jeder Zähler MUSS über einen Transmission Counter *C* mit einer Länge von 32 Bit verfügen*.* Erfolgt die Kommunikation zwischen Zähler und Smart-Meter-Gateway bidirektional, d.h. auf den Eingang eines Datensatzes erfolgt die Versendung einer Antwortnachricht, so MUSS auch das Smart-Meter-Gateway über einen zählerindividuellen Transmission Counter *C'* mit einer Länge von 32 Bit verfügen. Transmission Counter DÜRFEN NICHT überlaufen oder zurückgesetzt werden. Das Zurücksetzen der Transmission Counter ist ausnahmsweise nur direkt nach der Erzeugung eines neuen zählerindividuellen Schlüssels *MK* und vor dessen erster Verwendung erlaubt.

Vor der Versendung einer Nachricht MUSS der Zähler den Counterwert *C* gegenüber dem Counterwert der zuletzt authentisch empfangenen bzw. gesendeten Nachricht erhöhen (vgl. Kapitel [7.2](#page-22-0)).

Erfolgt die Kommunikation bidirektional, so MUSS auch das Smart-Meter-Gateway vor der Versendung einer Nachricht den Counterwert *C'* gegenüber dem Counterwert der zuletzt authentisch empfangenen bzw. gesendeten Nachricht erhöhen (vgl. Kapitel [7.2](#page-22-0)).

<span id="page-21-3"></span>[11](#page-21-2) Hierbei eingesetzte kryptographische Verfahren MÜSSEN den allgemeinen Empfehlungen der TR-02102 [2] entsprechen.

# <span id="page-22-0"></span>7.2 Schlüsselableitung

Vor jeder Übertragung eines neuen Datensatzes MÜSSEN aus dem Schlüssel *MK* die Schlüssel *KEnc* (für die Verschlüsselung) und *KMAC (*für die MAC-Berechnung) abgeleitet werden.

Die Berechnung der Schlüssel *KEnc* bzw. *KMAC* MUSS jeweils durch MAC-Bildung des aktuellen Counterwertes mit dem im Folgenden beschriebenen Verfahren unter Verwendung der Primitive aus [Tabelle 18](#page-22-1) geschehen. Hierbei MUSS stets sichergestellt werden, dass der in die Schlüsselableitung für einen zu sendenden Datensatz eingehende Counterwert größer ist als der zugehörige Counterstand der zuletzt authentisch empfangenen bzw. gesendeten Nachricht.

| Verfahren                                            | Mode                     | Länge | Verwendung von | Verwendung bis |  |
|------------------------------------------------------|--------------------------|-------|----------------|----------------|--|
| Berechnung von MK' bzw. KEnc,<br>KMAC, LEnc oderLMAC |                          |       |                |                |  |
| AES                                                  | CMAC gemäß RFC 4493 [10] | 128   | 2015           | 2030+          |  |

<span id="page-22-1"></span>*Tabelle 18: Berechnung der abgeleiteten Schlüssel*

Die Berechnung der Schlüssel *KEnc* bzw. *KMAC* für einen Datensatz erfolgt durch

- **•** *KEnc = MAC(MK,0x00*||*C*||*Zähler-ID)* bzw.
- **•** *KMAC = MAC(MK,0x01*||*C*||*Zähler-ID),*

wobei *0x00* bzw. *0x01* jeweils von der Länge 1 Byte sind. Der Input des MAC MUSS dabei vor Eingang in den MAC stets wie folgt auf Blocklänge aufgefüllt werden, wobei *l* jeweils die Bytelänge des Inputs und *I2OS()* die Konvertierungsfunktion von Integers nach Oktetts gemäß TR-03111 [3], Kapitel 3.1.2, bezeichnet:

- Anzahl der aufzufüllenden Oktetts: *16-(l mod 16)* Oktetts;
- Wert je aufzufüllender Oktett: *I2OS(16-(l mod 16)).*

Erfolgt die Kommunikation bidirektional, so MUSS auch das Smart-Meter-Gateway für die Versendung jedes Datensatzes neue Schlüssel *LEnc* und *LMAC* via

- **•** *LEnc = MAC(MK,0x10*||*C'*||*Zähler-ID) bzw.*
- **•** *LMAC = MAC(MK,0x11*||*C'*||*Zähler-ID)*

und dem gleichen Padding ableiten. Hierbei MUSS das Smart-Meter-Gateway einen Transmission Counter *C'* verwenden, der größer ist als Counterstand des zuletzt authentisch empfangenen bzw. gesendeten Datensatzes.

# 7.3 Übertragung von Zählerdaten

Die Übertragung der Daten MUSS stets verschlüsselt und MAC-gesichert erfolgen. Die übertragenen Daten MÜSSEN hierbei zuerst (mit dem abgeleiteten Schlüssel *KEnc bzw. LEnc)* verschlüsselt und danach werden die verschlüsselten Daten (mit *KMAC bzw. LMAC)* MAC-gesichert werden.

Hierbei MÜSSEN die Verfahren aus [Tabelle 19](#page-23-0) verwendet werden. Der Verwendungszeitraum bezieht sich auf die Herstellung des Zählers.

<span id="page-23-1"></span>

| Verfahren                                                                                                                              | Mode                                                                                                                        | Schlüssel<br>länge | Tag<br>länge  | Verwen-dung<br>von | Verwen<br>dung bis |
|----------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|--------------------|---------------|--------------------|--------------------|
|                                                                                                                                        | Verschlüsselung (mit KEnc bzw. LEnc)                                                                                        |                    |               |                    |                    |
| AES                                                                                                                                    | 12<br>CBC gemäß RFC 4493 [7] (IV=0)                                                                                         | 128                | -             | 2015               | 2030+              |
| Authentizität und Integritätssicherung (mit KMAC bzw. LMAC)<br>AES<br>CMAC gemäß RFC 4493 [10]. Der<br>128‍<br>128/64<br>2015<br>2030+ |                                                                                                                             |                    |               |                    |                    |
|                                                                                                                                        | MAC-Wert kann optional auf die<br>ersten 64 Bit gekürzt werden.                                                             |                    |               |                    |                    |
| Verschlüsselung, Authentizität und Integritätssicherung (mit KMAC bzw. LMAC)                                                           |                                                                                                                             |                    |               |                    |                    |
| AES                                                                                                                                    | CCM gemäß NIST SP 800-38C [9].<br>Das<br>Authentication<br>Tag<br>kann<br>optional gemäß [22] auf 64 Bit<br>gekürzt werden. | 128                | 128/96/6<br>4 | 2024               | 2030+              |

<span id="page-23-0"></span>*Tabelle 19: Symmetrische Absicherung der Datenübertragung*

#### **Anmerkung**:

- 1. Der Stand des Transmission Counters, der für die Ableitung der Schlüssel *KEnc* und *KMAC* bzw. *LEnc* und *LMAC* benötigt wird, MUSS unverschlüsselt aber MAC-gesichert übertragen werden. Zudem MUSS ein Zähler die Zähler-ID unverschlüsselt an das Smart-Meter-Gateway übertragen.
- 2. Die Wahl von IV=0 in der obigen [Tabelle 19](#page-23-0) ist möglich, da bei jeder Datenübertragung aus dem jeweiligen Counter insbesondere ein neuer Schlüssel *KEnc* bzw. *LEnc* abgeleitet wird, sodass *KEnc* bzw. *LEnc* jeweils nur einmalig mit IV=0 verwendet wird.
- 3. Die Verschlüsselung und MAC-Sicherung MUSS stets über einen vollständigen Datensatz von zu schützenden Daten erfolgen. Der Transport des Datensatzes KANN in mehreren Paketen erfolgen.
- 4. Zur Detektion von Replay-Attacken MUSS der Empfänger einer Nachricht bei jedem empfangenen Datensatz prüfen, dass der Transmission Counter des empfangenen Datensatzes größer als der des letzten empfangenen Datensatzes ist.
- 5. Um Replay-Attacken auch im Falle eines Stromausfalls zu vermeiden, MUSS stets sichergestellt werden, dass auch nach einem Stromausfall des Smart-Meter-Gateways ein Transmission Counter *C* vorliegt, der einen Wert aufweist, der nicht kleiner als 12 Stunden vor Beginn des Stromausfalls ist.

<span id="page-23-2"></span>[<sup>12</sup>](#page-23-1) Das Padding MUSS so gewählt werden, dass hierdurch keine Angriffe auf die Verschlüsselung möglich sind. Eine Möglichkeit ist das Padding aus Kapitel [7.2](#page-22-0). Das Padding DARF NICHT verarbeitet werden, bevor der MAC über das Chiffrat erfolgreich verifiziert wurde.

# <span id="page-24-0"></span>8 Inhaltsdatensicherung im WAN

Im Weitverkehrsnetz (WAN) der Smart-Meter-Gateway-Kommunikation erfolgt die Übermittlung von Daten nicht immer über einen direkten Transportkanal zwischen Sender und Endempfänger, sondern teilweise über dritte Parteien (z.B. den Gateway-Administrator). Daher geschieht der Austausch von Daten zwischen Kommunikationspartnern im WAN innerhalb eines TLS-Kanals auf der Basis von für den Endempfänger verschlüsselten und signierten Nachrichten im Cryptographic-Message-Syntax-Format gemäß RFC 5652 [30].

Hierbei muss das folgende Schema implementiert werden.

# <span id="page-24-4"></span>8.1 Authenticated-Enveloped-data Content Type

Für die Inhaltsdatenverschlüsselung MUSS der Authenticated-Enveloped-Data Content Type (vgl. RFC 5083 [31]) unter Verwendung eines ephemer-statischen Diffie-Hellman nach den Vorgaben der TR-03109-1 [23] verwendet werden.

### 8.1.1 Content-Authenticated-Encryption

Die Inhaltsdaten werden symmetrisch verschlüsselt und die verschlüsselten Daten werden MAC-gesichert (Content-Authenticated-Encryption). Hierbei MÜSSEN Verfahren aus [Tabelle 20](#page-24-1) für die Verschlüsselung und die MAC-Sicherung der Inhaltsdaten verwendet werden. Alle Verfahren der [Tabelle 20](#page-24-1) MÜSSEN unterstützt werden.

<span id="page-24-2"></span>

| Verfahren/Parameter                  |                                                                                        | Länge | Verwendung von | Verwendung bis |  |
|--------------------------------------|----------------------------------------------------------------------------------------|-------|----------------|----------------|--|
| AES-GCM                              |                                                                                        |       |                |                |  |
| Verschlüsselung<br>und Authentizität | AES-GCM gemäß RFC 5084 [32]13                                                          | 128   | 2015           | 2030+          |  |
| AES-CBC-CMAC                         |                                                                                        |       |                |                |  |
| Verschlüsselung                      | AES-CBC (IV=0) gemäß RFC 4493 [7]<br>mit Padding gemäß RFC 5652 [30],<br>Abschnitt 6.3 | 128   | 2015           | 2030+          |  |
| Authentizität                        | AES-CMAC gemäß RFC 4493 [10]                                                           | 128   | 2015           | 2030+          |  |

<span id="page-24-1"></span>*Tabelle 20: Inhaltsdatenverschlüsselung*

Die symmetrischen Schlüssel für die Verschlüsselung und MAC-Sicherung der Inhaltsdaten MÜSSEN (unmittelbar vor ihrer Verwendung) zufällig erzeugt werden. Ein Schlüssel DARF NICHT für die Versendung mehrerer Nachrichten verwendet werden.

*Bemerkung:* Die Wahl von IV=0 in der obigen Tabelle ist möglich, da bei jeder erneuten Inhaltsdatenverschlüsselung, d.h. für jedes neue Authenticated-Enveloped-Data-Paket, die symmetrischen Schlüssel neu generiert werden.

<span id="page-24-3"></span>[13](#page-24-2) Die Bitlänge des Initialisierungsvektors MUSS 96-Bit und die des Authentication Tags MUSS 128 Bit sein.

### 8.1.2 Schlüsselableitung und Key Encryption

Die zufällig erzeugten Schlüssel für die Verschlüsselung und MAC-Sicherung der Inhaltsdaten sind verschlüsselt im CMS-Container enthalten (Key Encryption).

Der Schlüssel *K* für die Key Encryption MUSS per ECKA-EG gemäß TR-03111 [3] berechnet werden. Die Ableitung von *K* MUSS mittels der X9.63 Key Derivation Function erfolgen (vgl. TR-03111 [3], Kapitel 4.3.3). ECKA-EG MUSS dazu gemäß TR-03111 [3], Kapitel 4.3.2.2 bzw. 5.3.1 (OIDs mit X9.63-KDF) implementiert werden.

[Tabelle 21](#page-25-2) enthält die Hashfunktionen und Kurvenparameter, die für ECKA-EG verwendet werden MÜSSEN. Die Verwendungszeiträume beziehen sich auf die Erstellung des zugrundeliegenden Verschlüsselungszertifikats.

| Verfahren/Parameter |                 | Verwendung von | Verwendung bis |
|---------------------|-----------------|----------------|----------------|
| Hash                | SHA-256         | 2015           | 2030+          |
| Kurvenparameter     | brainpoolP256r1 | 2015           | 2030+          |

<span id="page-25-2"></span>*Tabelle 21: Schlüsseltransport für die Inhaltsdatenverschlüsselung*

Die Key Encryption MUSS mit dem abgeleiteten Schlüssel *K* auf Basis symmetrischer Kryptographie erfolgen. Hierbei MÜSSEN die Verfahren aus [Tabelle 22](#page-25-1) verwendet werden.

| Verfahren/Parameter |                     | Verwendung von | Verwendung bis |
|---------------------|---------------------|----------------|----------------|
| Verschlüsselung     | id-aes128-wrap [33] | 2015           | 2030+          |
|                     |                     |                |                |

<span id="page-25-1"></span>*Tabelle 22: Algorithmen für die CMS Key Encryption*

# 8.2 Signed-Data Content Type

Die verschlüsselten und MAC-gesicherten Inhaltsdaten (Authenticated-Enveloped-Data Content Type, siehe Kapitel [8.1\)](#page-24-4) müssen anschließend signiert werden. Hierzu MUSS ECDSA, implementiert nach TR-03111 [3], verwendet werden.

[Tabelle 23](#page-25-0) enthält die Hashfunktionen und Kurvenparameter, die für die Signatur verwendet werden MÜSSEN. Die Verwendungszeiträume beziehen sich auf die Erstellung des zugrundeliegenden Signaturzertifikats.

| Verfahren/Parameter |                      | Verwendung von | Verwendung bis |
|---------------------|----------------------|----------------|----------------|
| Hash                | SHA-256              | 2015           | 2030+          |
| Kurvenparameter     | brainpoolP256r1 [13] | 2015           | 2030+          |

<span id="page-25-0"></span>*Tabelle 23: Signatur der verschlüsselten Inhaltsdaten*

# <span id="page-26-0"></span>9 Inhaltsdatensicherung in der Marktkommunikation

In der Marktkommunikation MÜSSEN die zu übermittelnden Daten neben der Absicherung auf Transportebene via TLS (vgl. Kapitel 4) innerhalb des TLS-Kanals auch auf Inhaltsebene unter Verwendung von XML Security entsprechend den W3C-Recommendations [34] und [35] und der SM-PKI entsprechend der TR-03109-4 [4] und der Certificate Policy der SM-PKI [15] abgesichert werden. Dieses Kapitel legt die hierbei einzusetzenden kryptographischen Parameter verbindlich fest.

# 9.1 Inhaltsdatensignatur

Die zu übermittelnden Daten MÜSSEN zuerst mit dem zum SM-PKI-Signaturzertifikat gehörenden privaten Schlüssel des Absenders signiert werden. [Tabelle 24](#page-26-2) enthält den Signaturalgorithmus und die Kurvenparameter, die für die Signatur verwendet werden MÜSSEN. Die Verwendungszeiträume beziehen sich auf die Erstellung des zugrundeliegenden Signaturzertifikats.

| Verfahren/Parameter |                                                                 | Verwendung von | Verwendung bis |
|---------------------|-----------------------------------------------------------------|----------------|----------------|
| Signaturverfahren   | http://www.w3.org/2001/04/<br>xmldsig-more#ecdsa-sha256<br>[35] | 2020           | 2030+          |
| Kurvenparameter     | brainpoolP256r1 [13]                                            | 2020           | 2030+          |

<span id="page-26-2"></span>*Tabelle 24: Signatur der Inhaltsdaten*

# 9.2 Inhaltsdatenverschlüsselung

Für die Verschlüsselung der signierten Inhaltsdaten für den Endempfänger MUSS das im Folgenden spezifizierte hybride kryptographische XML-Security-Profil verwendet werden.

Hierbei MUSS analog zu Kapitel 8 der öffentliche Schlüssel des SM-PKI-Verschlüsselungszertifikats des Endempfängers dazu genutzt werden, die Session Keys zu verschlüsseln (*Key Encryption*). Die Verschlüsselung der eigentlichen Datenpakete (*Content Encryption*) MUSS via symmetrischer Verschlüsselungsverfahren erfolgen.

#### 9.2.1 Content Encryption

Die eigentlichen Datenpakete MÜSSEN symmetrisch verschlüsselt und MAC-gesichert werden. Hierbei MÜSSEN Verfahren aus [Tabelle 25](#page-26-1) verwendet werden.

| Verfahren/Parameter                               | Länge | Verwendung von | Verwendung bis |
|---------------------------------------------------|-------|----------------|----------------|
| http://www.w3.org/2009/xmlenc11#aes128-gcm14 [36] | 128   | 2020           | 2030+          |

<span id="page-26-3"></span><span id="page-26-1"></span>*Tabelle 25: Inhaltsdatenverschlüsselung*

Die symmetrischen Schlüssel für die Verschlüsselung der Inhaltsdaten MÜSSEN (unmittelbar vor ihrer Verwendung) zufällig erzeugt werden. Ein Schlüssel DARF NICHT für die Versendung mehrerer Nachrichten verwendet werden.

<span id="page-26-4"></span>[14](#page-26-3) Die Bitlänge des Initialisierungsvektors MUSS 96 Bit und die des Authentication Tags MUSS 128 Bit sein.

### 9.2.2 Key Agreement und Key Encryption

Die Key Encryption MUSS als Schlüsselableitung (Key Agreement) umgesetzt werden.

Der Schlüssel *K* für die Key Encryption MUSS <http://www.w3.org/2009/xmlenc11#ECDH-ES> [36] gemäß TR-03111 [3], Kapitel 4.3.2.2 (hier als ECKA-EG bezeichnet), berechnet werden. Die Ableitung von *K* MUSS mittels<http://www.w3.org/2009/xmlenc11#ConcatKDF> [36] erfolgen.[15](#page-27-3)

<span id="page-27-2"></span>[Tabelle 26](#page-27-1) enthält die Hashfunktionen und Kurvenparameter, die für ECDH-ES verwendet werden MÜSSEN. Die Verwendungszeiträume beziehen sich auf die Erstellung des zugrundeliegenden Verschlüsselungszertifikats.

| Verfahren/Parameter |                                                  | Verwendung von | Verwendung bis |
|---------------------|--------------------------------------------------|----------------|----------------|
| Hash                | http://www.w3.org/2001/04/<br>xmlenc#sha256 [34] | 2020           | 2030+          |
| Kurvenparameter     | brainpoolP256r1 [13]                             | 2020           | 2030+          |

<span id="page-27-1"></span>*Tabelle 26: Schlüsseltransport für die Inhaltsdatenverschlüsselung*

Die Key Encryption MUSS mit dem abgeleiteten Schlüssel *K* auf Basis symmetrischer Kryptographie erfolgen. Hierbei MÜSSEN die Verfahren aus [Tabelle 27](#page-27-0) verwendet werden.

| Verfahren/Parameter |                                                     | Verwendung von | Verwendung bis |
|---------------------|-----------------------------------------------------|----------------|----------------|
| Verschlüsselung     | http://www.w3.org/2001/04/<br>xmlenc#kw-aes128 [34] | 2020           | 2030+          |

<span id="page-27-0"></span>*Tabelle 27: Algorithmen für die XML Key Encryption*

<span id="page-27-3"></span>[15](#page-27-2) Die ConcatKDF wird in NIST SP800-56A [37] spezifiziert. Die Vorgaben für Kürzung auf die jeweilige Schlüssellänge sind hierbei in NIST SP800-56C [38] dargelegt.

# <span id="page-28-0"></span>10 PACE und Secure Messaging

Für den Zugriff des Smart-Meter-Gateways auf das Sicherheitsmodul erfolgt eine gegenseitige Authentisierung beider Komponenten gemäß TR-03109-2 [39] mittels des PACE-Protokolls. PACE (Password Authenticated Connection Establishment) (vgl. TR-03109-2 [39] bzw. TR-03110 [40]) ist ein passwort-basiertes Authentisierungs- und Schlüsseleinigungsverfahren, bei dem aus einer gemeinsamen PIN[16](#page-28-3) Sitzungsschlüssel hoher Entropie für das anschließende Secure Messaging abgeleitet werden. Secure Messaging liefert einen verschlüsselten, authentisierten Kanal zwischen dem Smart-Meter-Gateway und dem Sicherheitsmodul (vgl. TR-03109-2 [39]).

<span id="page-28-2"></span>[Tabelle 28](#page-28-1) enthält die kryptographischen Verfahren sowie die Anzahl der dezimalen Zeichen der PIN, die für PACE verwendet werden MÜSSEN. Die angegebenen Verwendungszeiträume beziehen sich auf die Herstellung des Sicherheitsmoduls.

| Verfahren/Parameter |                                                         | Verwendung von | Verwendung bis |
|---------------------|---------------------------------------------------------|----------------|----------------|
| Algorithmus         | id-PACE-ECDH-GM-AES-CBC-CMAC-128<br>vgl. [39] bzw. [40] | 2015           | 2030+          |
| Kurvenparameter     | brainpoolP256r1                                         | 2015           | 2030+          |
| PACE-PIN            | Mindestens 10 Dezimalziffern                            | 2015           | 2030+          |

<span id="page-28-1"></span>*Tabelle 28: PACE und Secure Messaging*

Da die gewünschte Verwendungszeit der Komponenten eines Smart-Metering-Systems deutlich über den Verwendungszeitraum hinausgeht, wird (insbesondere für Komponenten ohne Update-Möglichkeit) EMPFOHLEN, zusätzlich auch die folgenden weiteren PACE-Algorithmen mit den elliptischen Kurven der entsprechenden Bitlängen zu unterstützen:

- **•** id-PACE-ECDH-GM-AES-CBC-CMAC-192 vgl. [39] bzw. [40]
- **•** id-PACE-ECDH-GM-AES-CBC-CMAC-256 vgl. [39] bzw. [40]

Das Smart-Meter-Gateway MUSS eine Secure Messaging Session auf maximal 48 Stunden begrenzen.

<span id="page-28-3"></span>[16](#page-28-2) Die PIN, die bei PACE zur Authentisierung des Smart-Meter-Gateways gegenüber dem Sicherheitsmodul verwendet wird, MUSS im Smart-Meter-Gateway geeignet geschützt werden, vgl. TR-03109-1 [23].

# <span id="page-29-0"></span>Literaturverzeichnis

| [1]  | BSI TR-03109, Technische Richtlinie BSI TR-03109, 2024                                      |
|------|---------------------------------------------------------------------------------------------|
| [2]  | BSI TR-02102-1, Kryptographische Verfahren: Empfehlungen und Schlüssellängen,               |
|      | Version 2024-01, 2024                                                                       |
| [3]  | BSI TR-03111, Elliptic Curve Cryptography (ECC), Version 2.10, 2018                         |
| [4]  | BSI TR-03109-4, Smart Metering PKI - Public Key Infrastruktur für Smart Meter               |
|      | Gateways, 2017                                                                              |
|      |                                                                                             |
| [5]  | IETF RFC 2119, S. Bradner, Key words for use in RFCs to indicate requirement levels,        |
|      | 1997                                                                                        |
| [6]  | NIST FIPS 197-upd1, Advanced Encryption Standard (AES), 2023                                |
| [7]  | ISO/IEC 10116:2017, Information technology -- Security techniques -- Modes of               |
|      | operation for an n-bit block cipher, 2017                                                   |
| [8]  | NIST<br>SP800-38D,<br>Recommendation<br>for<br>Block<br>Cipher<br>Modes<br>of<br>Operation: |
|      | Galois/Counter Mode (GCM) and GMAC, 2007                                                    |
| [9]  | IETF RFC 4493, JH. Song, R. Poovendran, J. Lee, T. Iwata, The AES-CMAC Algorithm, 2006      |
| [10] | NIST FIPS 180-4, Secure Hash Standard (SHS), 2015                                           |
| [11] | IETF RFC 5114, M. Lepinski, S. Kent, Additional Diffie-Hellman Groups for Use with IETF     |
|      | Standards, 2008                                                                             |
| [12] | IETF RFC 5639, M. Lochter, J. Merkle, Elliptic Curve Cryptography (ECC) Brainpool           |
|      | Standard Curves and Curve Generation, 2010                                                  |
| [13] | BSI AIS 20/31, A proposal for: Functionality classes for random number generators,          |
|      | Version 2.0, 2011                                                                           |
| [14] | BSI, Certificate Policy der Smart Metering PKI, 2023                                        |
| [15] | BSI TR-03116-TS, TLS Test-Specification, 2020                                               |
| [16] | IETF RFC 5246, T. Dierks, E. Rescorla, Transport Layer Security (TLS) Version 1.2, 2008     |
|      |                                                                                             |
| [17] | IETF RFC 8446, E. Rescorla, The Transport Layer Security (TLS) Protocol Version 1.3, 2018   |
| [18] | IETF RFC 5077, J. Salowey, H. Zhou, P. Eronen, H. Tschofenig, Transport Layer Security      |
|      | (TLS) Session Resumption without Server-Side State, 2008                                    |
| [19] | IETF RFC 5289, E. Rescorla, TLS Elliptic Curve Cipher Suites with SHA-256/384 and AES       |
|      | Galois Counter Mode (GCM), RFC 5289, 2008                                                   |
| [20] | IETF RFC 7027, J. Merkle, M. Lochter,<br>Elliptic Curve Cryptography (ECC) Brainpool        |
|      | Curves for Transport Layer Security (TLS), 2013                                             |
| [21] | IETF RFC 8422, Y. Nir, S. Josefsson, M. Pegourie-Gonnard, Elliptic Curve Cryptography       |
|      | (ECC) Cipher Suites for Transport Layer Security (TLS) Version 1.2 and Earlier, 2018        |
| [22] | BSI TR-03109-1, Anforderungen an die Interoperabilität der Kommunikationseinheit            |
|      | eines intelligenten Messsystems, 2024                                                       |
| [23] | IETF RFC 6066, D. Eastlake 3rd, Transport Layer Security (TLS) Extensions: Extension        |
|      | Definitions, 2011                                                                           |
| [24] | M. Bellare, C. Namprempre, Authenticated Encryption: Relations among notions and            |
|      | analysis of the generic composition paradigm; in Advances in Cryptology - Asiacrypt         |
|      | 2000 Proceedings, Lecture Notes in Computer Science Vol. 1976, T. Okamoto ed,               |
|      | Springer-Verlag, 2000                                                                       |
| [25] | IETF RFC 7366, P. Gutman, Encrypt-then-MAC for Transport Layer Security (TLS) and           |
|      | Datagram Transport Layer Security (DTLS), 2014                                              |
| [26] | K. Bhargavan, A. Delignat-Lavaud, C. Fournet, A. Pironti, P.-Y. Strub, Triple Handshake     |
|      | and Cookie Cutters: Breaking and Fixing Authentication over TLS, IEEE Symposium on          |
|      | Security and Privacy, 2014                                                                  |
| [27] | IETF RFC 7627, K. Bhargavan, Ed., A. Delignat-Lavaud, A. Pironti, A. Langley, M. Ray,       |
|      |                                                                                             |
|      | Transport Layer Security (TLS) Session Hash and Extended Master Secret Extension, 2015      |

- [28] IETF RFC 8734, L. Bruckert, J. Merkle, M. Lochter, Elliptic Curve Cryptography (ECC) Brainpool Curves for Transport Layer Security (TLS) Version 1.3, 2020
- [29] NIST SP800-38C, Recommendation for Block Cipher Modes of Operation: The CCM Mode for Authentication and Confidentiality, 2007

[29] IETF RFC 5652, R. Housley, Cryptographic Message Syntax (CMS), 2009

- [30] IETF RFC 5083, R. Housley, Cryptographic Message Syntax (CMS) Authenticated-Enveloped-Data Content Type, 2007
- [31] IETF RFC 5084, R. Housley, Using AES-CCM amd AES-GCM Authenticated Encryption in the Cryptographic Message Syntax (CMS), 2007
- [32] IETF RFC 3565, J. Schaad, Use of AES Encryption Algorithm in CMS, 2003
- [33] W3C Recommendation, XML Signature Syntax and Processing Version 1.1, 2013
- [34] IETF RFC 6931, D. Eastlake, Additional XML Security Uniform Resource Identifiers (URIs), 2013
- [35] W3C Recommendation, XML Encryption Syntax and Processing Version 1.1, 2013
- [36] NIST SP800-56A, Recommendations for Pair-Wise Key-Establishment Using Discrete Logarithm Cryptography, Revision 3, 2018
- [37] NIST SP800-56C, Recommendations for Key-Derivation Methods in Key-Establishment Schemes, Revision 2, 2020
- [38] BSI TR-03109-2, Smart Meter Gateway Anforderungen an die Funktionalität und Interoperabilität des Sicherheitsmoduls, 2014
- [39] BSI TR-03110, Advanced Security Mechanisms for Machine Readable Travel Documents and eIDAS Token, Version 2.21, 2016
- [40] BSI CC-PP-0073, Protection Profile for a Smart Meter Gateway (SMGW-PP), 2024
- [41] BSI CC-PP-0077-V2, Protection Profile for the Security Module of a Smart Metering System, 2015